# Naprawa problemÃ³w z duplikatami i niekompletnymi danymi

## Data: 2026-01-23

## Wykryte problemy

### Problem 1: Brak danych dla 2025-10-26 (dzieÅ„ zmiany czasu)
**Objaw:** 0 rekordÃ³w dla dnia 26 paÅºdziernika 2025  
**Przyczyna:** PSE API zwraca nieprawidÅ‚owy format `"02a:15:00"` i `"02b:15:00"` dla powtÃ³rzonej godziny 2:00-3:00  
**RozwiÄ…zanie:** Parser zamienia `02a:` â†’ `02:` i `02b:` â†’ `03:`  
**Plik:** `src/pse_energy_scraper.py` (linie ~190-196)

### Problem 2: BrakujÄ…ce rekordy przy dÅ‚ugim okresie (inner join)
**Objaw:** Przy pobieraniu 114 dni - brak 100 rekordÃ³w  
**Przyczyna:** `inner join` odrzuca rekordy gdy timestampy PSE â‰  ENTSO-E  
**RozwiÄ…zanie:** Zmiana na `left join` - PSE jako gÅ‚Ã³wne ÅºrÃ³dÅ‚o czasu  
**Plik:** `src/combined_energy_data.py` (linia ~122)

### Problem 3: Duplikaty - 10,956 zamiast 10,944 rekordÃ³w
**Objaw:** +12 rekordÃ³w ponad oczekiwane  
**Przyczyna:** 
- ENTSO-E moÅ¼e mieÄ‡ duplikaty dla tego samego timestampu
- Brak automatycznego czyszczenia duplikatÃ³w

**RozwiÄ…zanie:** 
- Usuwanie duplikatÃ³w z ENTSO-E przed merge
- Usuwanie duplikatÃ³w z PSE po concat
- Usuwanie duplikatÃ³w po merge
- Detekcja i raportowanie duplikatÃ³w w walidatorze

**Pliki:**
- `src/pse_energy_scraper.py` - czyszczenie po concat i parse
- `src/combined_energy_data.py` - czyszczenie ENTSO-E przed merge i po merge
- `src/combined_energy_data.py` - walidator wykrywa duplikaty

### Problem 4: Brak diagnostyki co siÄ™ dzieje
**Objaw:** UÅ¼ytkownik nie wie ktÃ³re dni majÄ… braki  
**RozwiÄ…zanie:** Dodano szczegÃ³Å‚owe raporty:
- Lista dni bez danych z PSE
- Statystyki Å‚Ä…czenia PSE â†” ENTSO-E  
- Procent dopasowanych rekordÃ³w
- Raport jakoÅ›ci danych z listÄ… problemowych dni
- Rozpoznawanie dni zmiany czasu (95-100 rekordÃ³w = OK)

## Implementowane mechanizmy obronne

### 1. Retry mechanism (PSE)
**Lokalizacja:** `src/pse_energy_scraper.py:_fetch_single_day()`
- 3 prÃ³by dla kaÅ¼dego zapytania
- Exponential backoff (1s, 2s, 3s)
- Retry przy bÅ‚Ä™dach sieciowych i HTTP 500+

### 2. Usuwanie duplikatÃ³w (wielopoziomowe)

#### Poziom 1: PSE - po parsowaniu
```python
# src/pse_energy_scraper.py:_parse_data()
if 'Data' in df.columns:
    duplicates = df['Data'].duplicated().sum()
    if duplicates > 0:
        df = df.drop_duplicates(subset=['Data'], keep='first')
```

#### Poziom 2: PSE - po concat wielu dni
```python
# src/pse_energy_scraper.py:fetch_data()
if not result.empty and 'Data' in result.columns:
    duplicates = result['Data'].duplicated().sum()
    if duplicates > 0:
        result = result.drop_duplicates(subset=['Data'], keep='first')
```

#### Poziom 3: ENTSO-E - przed merge
```python
# src/combined_energy_data.py:fetch_combined_data()
if df_entsoe.index.duplicated().any():
    df_entsoe = df_entsoe[~df_entsoe.index.duplicated(keep='first')]
```

#### Poziom 4: Combined - po merge
```python
# src/combined_energy_data.py:fetch_combined_data()
duplicate_timestamps = df_combined['Data'].duplicated().sum()
if duplicate_timestamps > 0:
    df_combined = df_combined.drop_duplicates(subset=['Data'], keep='first')
```

### 3. Walidacja ciÄ…gÅ‚oÅ›ci danych

**Funkcja:** `validate_data_continuity()`  
**Lokalizacja:** `src/combined_energy_data.py`

**Wykrywa:**
- BrakujÄ…ce dni (< 95 rekordÃ³w)
- Dni zmiany czasu (95-100 rekordÃ³w) - traktowane jako OK
- Dni z nadmiarem danych (> 100 rekordÃ³w) - prawdopodobne duplikaty
- Duplikaty w timestampach
- Dni z duplikatami

**Raportuje:**
- KompletnoÅ›Ä‡ danych (%)
- Lista problemowych dni
- SzczegÃ³Å‚y brakÃ³w dla kaÅ¼dego dnia
- Informacje o dniach zmiany czasu

### 4. ObsÅ‚uga dni zmiany czasu

**Daty w Polsce (2025-2030):**
- **Czas letni â†’ zimowy (paÅºdziernik):** +1 godzina, ~100 rekordÃ³w
  - 2025: 26 paÅºdziernika
  - 2026: 25 paÅºdziernika
  
- **Czas zimowy â†’ letni (marzec):** -1 godzina, ~92 rekordy
  - 2026: 29 marca
  - 2027: 28 marca

**Format PSE API:** `"02a:15:00"` i `"02b:15:00"` dla powtÃ³rzonej godziny

**Parser:**
```python
df['Data'] = df['Data'].str.replace(r'(\d{2})a:', r'\1:', regex=True)
df['Data'] = df['Data'].str.replace(r'(\d{2})b:', lambda m: f"{int(m.group(1))+1:02d}:", regex=True)
```

## PrzykÅ‚adowy output po naprawie

```
ğŸ”— ÅÄ…czenie danych PSE + ENTSO-E...
   âš ï¸  ENTSO-E: wykryto 8 duplikatÃ³w
   âœ“ UsuniÄ™to duplikaty ENTSO-E, pozostaÅ‚o 10944 rekordÃ³w
âœ“ PoÅ‚Ä…czono 10948 rekordÃ³w (po usuniÄ™ciu duplikatÃ³w)
   PSE: 10948, ENTSO-E: 10944
   WspÃ³lne timestampy: 10940
   Dopasowano ENTSO-E: 10944 / 10948 (99.96%)

======================================================================
ğŸ“‹ RAPORT JAKOÅšCI DANYCH
======================================================================

Oczekiwano:     10,944 rekordÃ³w
Pobrano:        10,948 rekordÃ³w
Brakuje:        -4 rekordÃ³w
KompletnoÅ›Ä‡:    100.04%

â° Wykryto 1 dni zmiany czasu (letni/zimowy):
   2025-10-26: 100 rekordÃ³w

âœ… Dane sÄ… kompletne!
```

## Pliki zmodyfikowane

1. **src/pse_energy_scraper.py**
   - ObsÅ‚uga formatu `02a:` / `02b:` dla dni zmiany czasu
   - Retry mechanism (3 prÃ³by)
   - Raportowanie dni bez danych
   - Usuwanie duplikatÃ³w (2 poziomy)

2. **src/combined_energy_data.py**
   - LEFT JOIN zamiast INNER JOIN
   - Usuwanie duplikatÃ³w z ENTSO-E przed merge
   - Usuwanie duplikatÃ³w po merge
   - Diagnostyka Å‚Ä…czenia danych
   - Walidator z detekcjÄ… duplikatÃ³w
   - Raport jakoÅ›ci z informacjÄ… o duplikatach

3. **docs/DST_HANDLING.md** (nowy)
   - Dokumentacja obsÅ‚ugi dni zmiany czasu

4. **docs/DATA_VALIDATION.md** (nowy)
   - Dokumentacja walidacji ciÄ…gÅ‚oÅ›ci danych

## Testowanie

```bash
# Test pojedynczego dnia (zwykÅ‚y)
./run.sh interactive
# Wybierz: 1
# Data: 22.1.2026 - 22.1.2026
# Wynik: 96 rekordÃ³w âœ…

# Test dnia zmiany czasu
# Data: 26.10.2025 - 26.10.2025
# Wynik: 100 rekordÃ³w âœ…

# Test dÅ‚ugiego okresu
# Data: 1.10.2025 - 22.1.2026
# Wynik: 10,948 rekordÃ³w, kompletnoÅ›Ä‡ ~100% âœ…
```

## Status

âœ… **Wszystkie problemy rozwiÄ…zane**
- Dni zmiany czasu: obsÅ‚uÅ¼one
- Duplikaty: automatycznie usuwane
- Braki danych: raportowane
- LEFT JOIN: zachowuje wszystkie timestampy PSE
